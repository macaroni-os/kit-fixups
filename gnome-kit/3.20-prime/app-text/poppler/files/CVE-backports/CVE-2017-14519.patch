Origin: Debian's poppler 0.18.4-6+deb7u3
Reviewed-By: Santiago R.R. <santiagorr@riseup.net>

From: Markus Koschany <apo@debian.org>
Date: Fri, 22 Sep 2017 14:51:02 +0200
Subject: CVE-2017-14519

Origin: https://cgit.freedesktop.org/poppler/poppler/commit/?id=aaf5327649e8f7371c9d3270e7813c43ddfd47ee
---
 poppler/Gfx.cc     | 24 ++++++++++++++++++++++--
 poppler/Gfx.h      |  1 +
 poppler/GfxFont.cc | 10 ++++++++++
 poppler/GfxFont.h  |  1 +
 4 files changed, 34 insertions(+), 2 deletions(-)

Index: poppler-0.48.0/poppler/Gfx.cc
===================================================================
--- poppler-0.48.0.orig/poppler/Gfx.cc
+++ poppler-0.48.0/poppler/Gfx.cc
@@ -4025,12 +4025,32 @@ void Gfx::doShowText(GooString *s) {
       state->transformDelta(dx, dy, &ddx, &ddy);
       if (!out->beginType3Char(state, curX + riseX, curY + riseY, ddx, ddy,
 			       code, u, uLen)) {
-	((Gfx8BitFont *)font)->getCharProc(code, &charProc);
+	((Gfx8BitFont *)font)->getCharProcNF(code, &charProc);
+	int refNum = -1;
+	if (charProc.isRef()) {
+		refNum = charProc.getRef().num;
+	}
 	if ((resDict = ((Gfx8BitFont *)font)->getResources())) {
 	  pushResources(resDict);
 	}
 	if (charProc.isStream()) {
-	  display(&charProc, gFalse);
+		std::set<int>::iterator charProcDrawingIt;
+		bool displayCharProc = true;
+		if (refNum != -1) {
+			if (charProcDrawing.find(refNum) == charProcDrawing.end()) {
+				charProcDrawingIt = charProcDrawing.insert(refNum).first;
+			} else {
+				displayCharProc = false;
+				error(errSyntaxError, getPos(), "CharProc wants to draw a CharProc that is already beign drawn");
+			}
+		}
+		if (displayCharProc) {
+			display(&charProc, gFalse);
+
+			if (refNum != -1) {
+				charProcDrawing.erase(charProcDrawingIt);
+			}
+		}
 	} else {
 	  error(errSyntaxError, getPos(), "Missing or bad Type3 CharProc entry");
 	}
Index: poppler-0.48.0/poppler/Gfx.h
===================================================================
--- poppler-0.48.0.orig/poppler/Gfx.h
+++ poppler-0.48.0/poppler/Gfx.h
@@ -226,6 +226,7 @@ private:
   MarkedContentStack *mcStack;	// current BMC/EMC stack
 
   Parser *parser;		// parser for page content stream(s)
+  std::set<int> charProcDrawing; // the charProc that are being drawn
   
   std::set<int> formsDrawing;	// the forms that are being drawn
 
Index: poppler-0.48.0/poppler/GfxFont.cc
===================================================================
--- poppler-0.48.0.orig/poppler/GfxFont.cc
+++ poppler-0.48.0/poppler/GfxFont.cc
@@ -1818,6 +1818,16 @@ Object *Gfx8BitFont::getCharProc(int cod
   return proc;
 }
 
+Object *Gfx8BitFont::getCharProcNF(int code, Object *proc) {
+  if (enc[code] && charProcs.isDict()) {
+    return charProcs.dictLookupNF(enc[code], proc);
+  } else {
+      proc->initNull();
+  }
+  return proc;
+}
+
+
 Dict *Gfx8BitFont::getResources() {
   return resources.isDict() ? resources.getDict() : (Dict *)NULL;
 }
Index: poppler-0.48.0/poppler/GfxFont.h
===================================================================
--- poppler-0.48.0.orig/poppler/GfxFont.h
+++ poppler-0.48.0/poppler/GfxFont.h
@@ -353,6 +353,7 @@ public:
 
   // Return the Type 3 CharProc for the character associated with <code>.
   Object *getCharProc(int code, Object *proc);
+  Object *getCharProcNF(int code, Object *proc);
 
   // Return the Type 3 Resources dictionary, or NULL if none.
   Dict *getResources();
